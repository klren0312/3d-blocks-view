<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      background: #333;
    }

    .container {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      background: #000;
    }

    .block {
      width: 480px;
      height: 636px;
      overflow: hidden;
      transform-style: preserve-3d;
      /* transition: transform 300ms ease-out; */
      border-radius: 5px;
    }

    .inner {
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
    }

    .img {
      background-image: url(./images/row6col8-2.jpg);
      background-size: 100% 100%;
      opacity: 1;
    }
  </style>
</head>

<body>
  <div id="js-container" class="container">
    <div id="js-block" class="block">
      <div class="inner">
        <div class="img" id="js-img"></div>
      </div>
    </div>
  </div>
  <select name="" id="js-select" onchange="changeImage(this.value)">
    <option value="./images/row6col8-2.jpg">row6col8-2.jpg</option>
    <option value="./images/row6col8.jpg">row6col8.jpg</option>
    <option value="./images/row8col10.jpg">row8col10.jpg</option>
    <option value="./images/row9col5-1.jpg">row9col5-1.jpg</option>
    <option value="./images/row9col5-2.jpg">row9col5-2.jpg</option>
    <option value="./images/row9col12.jpg">row9col12.jpg</option>
  </select>

  <script>
    let row = 6
    let col = 8
    let totalViews = row * col // 总视图数
    let initialIndex = Math.floor(totalViews / 2); // 计算中间索引
    let { rowNum: initialRow, colNum: initialCol } = getCoordinates(row, col, initialIndex);
    const img = document.getElementById('js-img')
    img.style.width = `calc(100% * ${col})`
    img.style.height = `calc(100% * ${row})`
    img.style.transform = `translate(calc(-100% / ${col} * ${initialCol}),calc(-100% / ${row} * ${initialRow}))`;
    const block = document.getElementById('js-block')

    let currentX = 0;
    let targetX = 0;
    let velocity = 0;
    let friction = 0.8; // 摩擦系数，值越小惯性越强

    let lastMouseX = 0;
    let lastTime = 0;
    let mouseSpeed = 0;
    const maxSpeed = 5; // 限制最大速度

    block.addEventListener('mousemove', function (e) {
      const rect = block.getBoundingClientRect();
      const currentMouseX = e.clientX - rect.left;
      const currentTime = Date.now();

      // 计算鼠标速度
      if (lastTime !== 0) {
        const deltaX = currentMouseX - lastMouseX;
        const deltaTime = currentTime - lastTime;
        mouseSpeed = deltaX / deltaTime; // 速度 = 距离 / 时间

        // 限制最大速度
        if (mouseSpeed > maxSpeed) {
          mouseSpeed = maxSpeed;
        } else if (mouseSpeed < -maxSpeed) {
          mouseSpeed = -maxSpeed;
        }
      }

      lastMouseX = currentMouseX;
      lastTime = currentTime;

      targetX = currentMouseX;
    });

    function animate() {
      // 使用缓动函数平滑速度变化
      velocity += (targetX - currentX) * 0.05 * Math.abs(mouseSpeed);
      velocity *= friction;
      currentX += velocity;

      // 计算当前索引
      const blockWidth = block.offsetWidth;
      const unitWidth = Math.round(blockWidth / totalViews);
      let theIndex = Math.round(currentX / unitWidth);

      // 确保索引在有效范围内
      if (theIndex < 0) {
        theIndex = 0;
      } else if (theIndex > totalViews - 1) {
        theIndex = totalViews - 1;
      }

      const { rowNum, colNum } = getCoordinates(row, col, theIndex);

      // 设置旋转角度和视点图
      const container = document.getElementById('js-container');
      const rotateY = (currentX - blockWidth / 2) / blockWidth * 30;
      block.style.transform = `perspective(${container.offsetHeight ? container.offsetHeight * 2 : 2400}px) rotateY(${rotateY}deg)`;
      img.style.transform = `translate(calc(-100% / ${col} * ${colNum}),calc(-100% / ${row} * ${rowNum}))`;

      requestAnimationFrame(animate);
    }

    animate();

    // 获取当前指定视图的坐标
    function getCoordinates(rows, cols, index) {
      const row = Math.floor(index / cols);
      const col = cols - 1 - (index % cols);
      return { rowNum: row, colNum: col };
    }

    function changeImage(value) {
      const object = {
        './images/row6col8.jpg': { row: 6, col: 8 },
        './images/row6col8-2.jpg': { row: 6, col: 8 },
        './images/row8col10.jpg': { row: 8, col: 10 },
        './images/row9col5-1.jpg': { row: 9, col: 5 },
        './images/row9col5-2.jpg': { row: 9, col: 5 },
        './images/row9col12.jpg': { row: 9, col: 12 },
      }
      row = object[value].row
      col = object[value].col
      totalViews = row * col
      initialIndex = Math.floor(totalViews / 2);
      let { rowNum: initialRow, colNum: initialCol } = getCoordinates(row, col, initialIndex);

      img.style.backgroundImage = `url(${value})`
      img.style.width = `calc(100% * ${col})`
      img.style.height = `calc(100% * ${row})`
      img.style.transform = `translate(calc(-100% / ${col} * ${initialCol}),calc(-100% / ${row} * ${initialRow}))`;
    }

  </script>
</body>

</html>